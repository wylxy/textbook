# 数字化社区管理系统
## 简单介绍
功能模块：
- 重点人群模块
  - 重点人群申请  
    有权限的用户手动录入重点人员的信息，并提交审核。
  - 重点人群管理  
    查看当前重点人群的列表，并对重点人群进行管理，包括删除、更新、获取信息等操作。
- 审核模块
  - 重点人员审核  
    对重点人员的申请进行审核，审核通过后，重点人员信息会被添加到重点人员列表中。  
    审核可能包含多级审批，每一级审批都需要具有相对应权限的用户进行审核。  
- 街道信息管理模块
  - 添加街道信息
  - 街道信息管理  
    对街道信息进行管理，包括删除、更新、获取信息等操作。
- 居民信息管理模块
  - 添加居民信息
  - 居民信息管理  
    对居民信息进行管理，包括删除、更新、获取信息等操作。
- 权限管理
  - 角色管理
  - 添加角色  
    允许创建一个角色和账号进行绑定，例如创建一个重点人群录入员的角色，然后将这个角色绑定到一个账号上，
    这个账号就拥有了重点人群录入员的权限。
## 部署
项目采用前后端分离的方式进行开发，前端使用Vue2进行开发。  
前端代码放在另一个压缩包里，在前端目录里使用`npm run serve`命令即可启动前端项目，需要安装`npm 14`才能启动。  

项目使用Maven进行依赖管理，使用主要技术为Spring + SpringMVC + Mybatis，  
关键技术版本：
- Java 8
- Tomcat 9.0
- MySQL 8
- Spring 5.3.27
- Mybatis 3.5.6

数据库表结构的文件在附带的.sql文件中，使用mysql8直接运行以后可以恢复数据库，里面包含少量测试数据

后端项目可以直接使用maven编译成war以后由tomcat启动，或者在idea里添加tomcat9的运行配置。

项目启动以后访问`/swagger-ui.html`即可打开swagger-ui界面，可以在这里可以看到所有的接口并进行接口测试。

项目使用了token来校验用户权限，如果使用swagger-ui进行接口测试，需要先登录获取token，然后在swagger-ui界面的右上角点击`Authorize`按钮，输入`Bearer {token}`登录后即可进行接口测试。  
如果不使用swagger，则需要在http请求头里加上Authorization字段，值为`Bearer {token}`，然后发送请求。  
可以使用账号`admin`密码`123456`进行登录  

## 流程管理

需要实现一个统一的流程管理功能，类似于钉钉的提交审批。

这个流程管理模块是一个通用、可拓展的模块，可以让其他模块很方便的接入到这个模块。比如说现在已经有了一个重点人群管理模块，这个模块是由有权限的信息录入人员进行信息录入，录入成功以后可以选择交给谁来审批，并且审批可能是多级的。

需要让这个模块易于拓展，比如说今后可能会开发一个低保人群管理模块，也需要使用这个流程管理功能，那么低保人群管理模块应该可以非常方便的使用这个模块或者说是接入到这个模块，要实现一定程度上的解耦。

最重要的一个地方是，需要通过这个模块来体现出spring这个框架的好处，体现出使用了spring框架以后，可以非常方便的实现上面所说的可拓展、通用的目标。

## 权限管理

新建一个角色表和权限表，角色表和权限表是多对多的关系

可以给系统里的账号分配角色，一个账号也可以有多个角色。这个角色就类似于权限组的概念。

然后系统里进行各种操作，例如说添加街道，删除街道，添加居民，删除居民等等，每个操作都对应一个权限。

需要先创建角色，然后给角色添加权限，再给账号添加角色，这样账号就拥有了相应的权限。

例如说，账号a添加“录入员”和“街道工作人员”两个角色，
其中“录入员”角色拥有“添加居民”权限，可以录入居民信息，
“街道工作人员”角色拥有“查询街道信息”，“查询居民信息”的权限，
那么账号a就拥有了三个权限。

存在一个问题，权限要不要进一步细分，比如说“添加居民”的权限，是有了这个权限就可以给所有街道添加居民信息吗，
如果是这样的话，系统实现可能比较复杂，暂时想不出好的实现方案

## 实现情况
### 居民信息管理

居民管理主要包含居民的删除、更新、获取信息、添加以及列表查询等功能，主要用于支持重点人员模块。

#### 删除居民

此功能通过提供居民ID进行删除操作。系统首先会获取当前登录的用户信息，根据权限进行相应的操作。如果当前用户是街道工作人员，只能删除本街道的居民。如果删除成功，返回成功信息，否则返回失败信息。

#### 更新居民信息

此功能通过提供居民创建DTO（包含居民信息）来更新居民信息。系统首先会检查提供的身份证号是否合法，然后将DTO中的数据复制到居民实体中，最后更新居民信息并返回成功或失败的结果。

如果是街道办工作人员，只能修改自己街道所属居民的信息。

#### 获取居民信息

此功能通过提供居民ID来获取居民信息。系统首先从数据库中查询该居民，然后将查询到的居民实体转换为DTO，并返回查询结果。

#### 添加居民

此功能通过提供居民创建DTO（包含居民信息）来添加新的居民。系统首先会检查提供的身份证号是否合法，然后将DTO中的数据复制到居民实体中，最后插入新的居民信息并返回成功或失败的结果。

#### 获取居民列表

此功能通过提供页码和页面大小来获取居民信息列表，可以通过居民姓名来模糊查询。系统首先检查输入的页码和页面大小是否合法，不合法则提供默认分页参数，然后从数据库中查询相应的居民列表，最后将查询到的居民实体列表转换为DTO列表，并返回查询结果。



### 街道信息管理

主要负责街道的添加、统计、分页查询、通过id查询、通过id更新以及通过id删除等功能。

街道信息主要用于支持居民、工作人员的信息。对于街道办工作人员，有些操作只对他所属的街道有操作权限。

#### 添加街道

此功能通过提供街道创建DTO（包含街道信息）来添加新的街道。系统首先将DTO中的数据复制到街道实体中，然后插入新的街道信息并返回成功或失败的结果。

#### 统计街道数量

此功能不需要提供任何参数，系统将查询并返回街道的总数量，用于分页查询时方便前端传递参数。

#### 分页查询街道列表

此功能通过提供页码和页面大小来获取街道信息列表。系统首先检查输入的页码和页面大小是否合法，然后从数据库中查询相应的街道列表，最后将查询到的街道实体列表转换为DTO列表，并返回查询结果。

#### 通过id查询街道信息

此功能通过提供街道ID来获取街道信息。系统首先从数据库中查询该街道，然后将查询到的街道实体转换为DTO，并返回查询结果。

#### 通过id更新街道信息

此功能通过提供街道DTO（包含街道信息）来更新街道信息。系统首先会检查街道是否存在，然后获取当前登录的用户信息，根据权限进行相应的操作。如果当前用户是街道工作人员且要修改的街道是自己所在的街道，或者当前用户是政府工作人员，系统将将DTO中的数据复制到街道实体中，然后更新街道信息并返回成功或失败的结果。

#### 通过id删除街道

此功能通过提供街道ID来删除街道。系统首先会检查街道是否存在，然后获取当前登录的用户信息，根据权限进行相应的操作。如果当前用户是政府工作人员，系统将删除该街道并返回成功或失败的结果。如果当前用户是街道工作人员，系统将返回权限不足的错误信息。

### 重点人群管理

目前的逻辑是，工作人员（社区/街道办）发起添加重点人群的请求，然后管理员审批请求，最后重点人群信息才会被添加到数据库中。

一个重点人群，一定是一个居民，添加的时候需要提供居民id

> 重点人群中有一个分类，目前分类是固定的，后续可以考虑添加分类管理模块以便灵活添加，或者是分类改为字符串来储存

#### 发送添加重点人群请求

此功能通过提供重点人群创建DTO（包含重点人群信息）来创建一个申请，申请被政府用户通过以后才会添加一个重点人群。

#### 审批重点人群添加请求

此功能通过提供申请审批DTO（包含审批信息）来审批新的重点人群。系统首先检查参数合法性和用户权限，然后修改申请状态，如果申请通过，则重点人群添加到数据库中，并返回成功或失败的结果。

审批完成以后还会在请求上添加上审批意见。

#### 通过id查询重点人群信息

此功能通过提供重点人群ID来获取重点人群信息。系统首先从数据库中查询该重点人群，然后将查询到的重点人群实体转换为DTO，并返回查询结果。

#### 分页查询重点人群列表

此功能通过提供页码和页面大小来获取重点人群信息列表，可以通过姓名来模糊搜索。系统首先检查输入的页码和页面大小是否合法，然后从数据库中查询相应的重点人群列表，最后将查询到的重点人群实体列表转换为DTO列表，并返回查询结果。

#### 通过id更新重点人群信息

此功能通过提供重点人群DTO（包含重点人群信息）来更新重点人群信息。系统首先会检查重点人群是否存在，然后将DTO中的数据复制到重点人群实体中，然后更新重点人群信息并返回成功或失败的结果。

#### 通过id删除重点人群

此功能通过提供重点人群ID来删除重点人群。系统首先会检查重点人群是否存在，然后删除该重点人群并返回成功或失败的结果。

### 用户管理（社区/街道/政府的工作人员）

用户的权限分为三种，社区、街道、政府，分别对应不同的功能。

主要负责用户的登录、注册、信息获取和修改等功能。具体实现如下：

#### 用户登录

用户可以通过输入用户名和密码进行登录。系统将验证用户名和密码的正确性。如果验证通过，系统将生成一个token，并返回给用户。用户在之后的操作中需要携带这个token以证明身份。

#### 用户信息获取

用户可以通过提供用户id获取用户信息，包括用户名、联系方式、街道id、姓名等。如果查询的用户不存在，系统将返回错误信息。

#### 用户注册

新用户可以通过提供用户名、密码、联系方式、街道id、姓名和角色等信息进行注册。系统将检查注册参数的合法性，包括用户名的长度、联系方式的合法性等。如果注册参数合法，系统将检查用户名是否已存在，如果不存在，系统将将新用户信息添加到数据库中。

#### 用户信息修改

用户可以通过提供用户id和新的用户信息进行信息修改。系统将检查参数的合法性，并检查用户是否存在。如果参数合法且用户存在，系统将更新用户信息。在这个过程中，只有用户名、联系方式、街道id和姓名可以被修改。

如果想要添加新的账号或者修改账号权限，当前登录的账号必须是政府账号

如果想要修改用户信息，政府可以修改所有人的信息，其余账号只能修改自己的信息

#### 用户密码修改

用户可以修改自己的密码。系统将获取当前登录的用户id，并使用新的密码更新用户的密码。

#### 用户角色修改

只有政府用户可以修改其他用户的角色。系统将获取当前登录的用户id，检查该用户是否为真毒。如果是，系统将检查要修改的用户是否存在，如果存在，系统将将新的角色更新到数据库中

## 备注

### 登录过滤器
登录过滤器的白名单使用application.properties实现

实际上，@WebFilter是Servlet的注解，属于Servlet容器的内容，Spring容器不参与管理

代码中同时加上@WebFilter和@Component注解，
会让过滤器同时添加到Servlet容器和Spring容器中，但实际上两个容器中是不同的对象

为了让Servlet容器中的过滤器能够通过Spring的@Value读取到配置文件里的白名单，
需要在过滤器中添加一个静态的白名单字段，然后在非静态的setter方法上加上@Value注解。

这样，spring容器中的过滤器就能够通过@Value注解读取到配置文件里的白名单，同时，Servlet容器中的过滤器也能够通过静态字段读取到白名单。